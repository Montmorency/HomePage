      PROGRAM EXPROC

      IMPLICIT REAL*8(A-H,O-Z)

      DIMENSION A(15,5),B2(15,5),AA(15),BB2(15),WORK(15,6)

     1,ATR(15),BTR2(15),TABS(301,5),IWK(15),EB(2),IWK2(15)

      NPTS=301

      ALP=0.5

      LL=15

      ELO=-0.5

      EHI=0.1

      EPS=5.0E-12

      ACC=1.0E-6

      NP=1

C  HL trying to get hydrogen working increasing NW may allow for more structure in DOS.
      NW=15

      DE=(EHI-ELO)/FLOAT(NPTS-1)

C  LL IS THE LENGTH OF THE C.F. , NP IS THE NUMBER OF DIFFERENT C.F.S

C  ELO-EHI IS THE RANGE OF ENERGIES OF INTEREST,

C  NPTS IS THE NUMBER OF POINTS TO BE USED IN PLOTTING

C  EPS IS THE ACCURACY REQUIRED

      READ(5,21)IWK

21    FORMAT(15A4)

      WRITE(6,21)IWK

      DO 1 I=1,NP

22    FORMAT(53X,I3)

      READ(5,22)LLIN

1     READ(5,2)(A(J,I),B2(J,I),J=1,LLIN)

2     FORMAT(5X,2E14.6)

3     FORMAT(' INPUT CONTINUED FRACTION CFTS.',50(/1X,10F8.4))

      WRITE(6,3)((A(I,J),B2(I,J),J=1,NP),I=1,LLIN)

C

C COMPUTE THE SUM OF THE INPUT DENSITIES AND STORE THE RESULTING

C COEFFICIENTS IN AA AND BB2

C CALL RECSUM(A,B2,NW,LL,NP,AA,BB2,EPS,TABS,301)
C HL NO NEED TO SUM MULTIPLE CFs FOR SINGLE S ORBITAL.

C IF LL NEGATIVE THEN RECQD FAILED WITH TOO FEW ROOTS.
      DO 23 I=1,LL
      AA(I) = A(I,1)
23    BB2(I) = B2(I,1)

      WRITE(6,*) AA, BB2
      WRITE(6,2)

      WRITE(6,12)LL

      WRITE(6,2)(AA(J),BB2(J),J=1,LL)

C

C GENERATE TERMINATOR FOR SUMMED DENSITIES

C

      ERR=ACC

C     NBP1=2 number of bands
CHL  For BCC had to up this parameters...
      NBP1=3

      LTR=LL

      WRITE(6,*) "HL: LL", LL

      CALL TERMGN(AA,BB2,LTR,EPS,ERR,30,EDGE,WIDTH,WEIGHT,NBP1,ATR,

     1 BTR2,IWK,WORK,NW,TABS,301,IWK2)


      WRITE(6,99)EDGE,WIDTH,WEIGHT,ERR,NBP1

99    FORMAT(' EDGE',E13.5,' WIDTH',E13.5,' WEIGHT',E13.5,

     1/' ERROR IN MATCH',E13.5,' CODE',I4)

      WRITE(6,98)(ATR(I),BTR2(I),I=1,LTR)

98    FORMAT(' TERMINATOR COEFFICIENTS :',20(/2E16.8))

C

C  TABULATE D.O.S. ETC. USING C.P.C. ROUTINES

C


      WRITE(6,2)

      WRITE(6,*)'#DOS'
      WRITE(6,5)

5     FORMAT('#',5X,' ENERGY',5X,' TERM.DOS',5X,'QUAD.DOS',4X,

     1' INTEGRATED DOS "STRUCTURAL ENERGY"')
      DO 55 I=1,NPTS

      TABS(I,1)=ELO+FLOAT(I-1)*DE


C TERM DOS:
      TABS(I,5)=DENCRS(TABS(I,1),AA,BB2,LL,EDGE,WIDTH,WEIGHT,1,

     1 ATR,BTR2)


C QUAD DOS:
      TABS(I,2)=DENQD(TABS(I,1),TABS(I,1),AA,BB2,LL,ALP,EPS,WORK,NW,

     1 NQ,NE,IWK)


      IF(NE.LE.0)GOTO 13

      TABS(I,3)=WORK(NE,2)*(ALP-1.0)

      TABS(I,4)=WORK(NE,1)*TABS(I,3)

      DO 4 J=1,NE

      TABS(I,3)=TABS(I,3)+WORK(J,2)

4     TABS(I,4)=TABS(I,4)+WORK(J,2)*WORK(J,1)

55    WRITE(6,6)TABS(I,1),TABS(I,5),(TABS(I,J),J=2,4)
      WRITE(6,*)'ENDDOS'

6     FORMAT(5E14.5)

C

C  FIND THE FERMI ENERGY FOR INTEGER NUMBERS OF ELECTRONS

C  THE FIRST CALL FINDS THE F.E. OF THE SUMMED DENSITIES ,

C  AND THE SECOND FINDS IT FROM THE SUM OF THE ORIGINAL DENSITIES.

C  THE LATTER SHOULD BE MORE ACCURATE, GIVING SOME IDEA OF THE ACCURACY

C  OF THE APPROXIMATIONS BEING MADE.

C

      WRITE(6,2)

      WRITE(6,11)

      EB(1)=TABS(1,1)

      DO 9 M=1,4

      DUM=EB(1)

      EB(2)=TABS(NPTS,1)

      AN=FLOAT(M)

      IFT=60

      EF=FENVAL(AN,AA,BB2,NW,LL,1,ACC,EPS,EB,WORK,NW,IWK,IFT)

      IFT=60

      EB(2)=TABS(NPTS,1)

      EB(1)=DUM

      EFAC=FENVAL(AN,A,B2,NW,LL,NP,ACC,EPS,EB,WORK,NW,IWK,IFT)

      WRITE(6,10)M,EF,EFAC

      EB(1)=EF

9     CONTINUE

10    FORMAT(I12,6X,2E18.8)

11    FORMAT(' NO. OF ELECTRONS',5X,'FERMI ENERGY   MORE ACCURATE F.E.')

12    FORMAT(' RESULTANT CONTINUED FRACTION COEFFICIENTS',/I3

     1 ,' LEVELS USED')

      STOP

13    WRITE(6,14)NE,TABS(I,1)

14    FORMAT(' DENQD FAILED WITH NE=',I6,' AT E=',E13.5)

      END


